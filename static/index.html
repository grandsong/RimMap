<!DOCTYPE html>
<html lang="en">

<head>
	<meta charset="UTF-8">
	<title>Rimmap - Web based Rimworld map viewer!</title>
	<link rel="stylesheet" href="styles/main.css">
	<link rel="stylesheet" href="styles/ui.css">
</head>

<body>
	<div id="blackout">
		<div class="sk-folding-cube">
			<div class="sk-cube1 sk-cube"></div>
			<div class="sk-cube2 sk-cube"></div>
			<div class="sk-cube4 sk-cube"></div>
			<div class="sk-cube3 sk-cube"></div>
		</div>
		<h1>Loading...</h1>
		<i id="loadingMsg">Initializing...</i>
	</div>
	<div id="content">

		<div id="window"></div>
		<div id="ui">

			<div id="topbar">
				<span id="FileName"><span id="MapName"></span> <span id="MapSize"></span></span>

				<!--<div class="maps">
					<select id="levels">
						<option>Option2</option>
						<option>Option1</option>

					 </select>
				</div>-->
				<button id="reloadButton" onclick="location.reload()"> upload new</button>
			</div>

			<div id="filemanager">
			<div id="filegroup">
				<input type="file" id="file_input" accept=".rws" onchange="uploadSave(this);" />
				<label for="file">
					<svg version="1.1" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink">
					    <!--Generated by IJSVG (https://github.com/curthard89/IJSVG)-->
					    <g fill="none">
					        <path d="M0,0h24v24h-24Z" transform="translate(0, 0.006)"></path>
					    </g>
					    <g id="dlSvg" fill="#ffffff">
					        <path d="M0,4.707l1.414,1.414l2.293,-2.293v12.586h2v-12.586l2.293,2.293l1.414,-1.414l-4.707,-4.707Z" transform="translate(7.293, 5.588)"></path>
					        <path d="M14,0h-12c-1.104,0 -2,0.896 -2,2v10c0,1.102 0.896,2 2,2h1v-2h-1v-10h12v10h-1v2h1c1.104,0 2,-0.898 2,-2v-10c0,-1.104 -0.896,-2 -2,-2Z" transform="translate(4, 2.002)"></path>
					    </g>
					</svg>
				</label>
				<h3>Upload Rimworld save file</h3>

			</div><!--Filemanager-->



			<div id="savesgroup">
				<div id="novaSave" class="singleSave" onclick="loadSave('Nova.rws')">
					<div class="mapinfo">Nova - 250x250 - Medium colony</div>
				</div>
				<div id="temperateSave" class="singleSave" onclick="loadSave('Temperate.rws')">
					<div class="mapinfo">Temperate - 250x250 - Empty temperate forrest</div>
				</div>
				<div id="growthsThumb" class="singleSave" onclick="loadSave('GrowthsValley.rws')">
					<div class="mapinfo">Growth's Valley - 275x275 - Large colony</div>
				</div>
				<!--<div id="save3" class="singleSave" onclick="loadSave('Arrivals.rws')">
					Arrivals
				</div>
				<div id="save4" class="singleSave" onclick="loadSave('Arrivals.rws')">
					Arrivals
				</div>
				<div id="save3" class="singleSave" onclick="loadSave('Arrivals.rws')">
					Arrivals
				</div>-->
			</div>
		</div>

		<div id="settingsBar" class="bottomBar">
			<div class="switchContain">
				<span class="sliderName">HD</span>
				</br>
				<label id="hdSwitch" class="switch">
					<input id="hdCheckbox" name="hdCheckbox" type="checkbox" onchange="toggleHD()" checked />
					<span class="slider round"></span>
				</label>
			</div>
			<div id="versionNum">RimMap v3.1 - @james_simo</div>
		</div>

			<div id="mainGameBar" class="bottomBar">
				<div class="switchContain">
					<span class="sliderName">Items</span>
					</br>
					<label id="stuffSwitch" class="switch">
						<input id="stuffCheckbox" name="stuffCheckbox" type="checkbox" onchange="toggleStuff()" checked />
					  <span class="slider round"></span>
					</label>
				</div>
				<!--<div class="switchContain">
					<span class="sliderName">Roof</span>
					</br>
					<label id="roofSwitch" class="switch">
						<input id="roofCheckbox" name="roofCheckbox" type="checkbox" onchange="toggleRoof()" />
					  <span class="slider round"></span>
					</label>
				</div>-->
				<div class="switchContain">
					<span class="sliderName">Mountains</span>
					</br>
					<label id="mountainsSwitch" class="switch">
						<input id="mountainCheckbox" name="mountainCheckbox" type="checkbox" onchange="toggleMountain()" checked />
					  <span class="slider round"></span>
					</label>
				</div>
				<div class="switchContain">
					<span class="sliderName">Resources</span>
					</br>
					<label id="resourceSwitch" class="switch">
						<input id="resourceCheckbox" name="resourceCheckbox" type="checkbox" onchange="toggleResource()"  />
					  <span class="slider round"></span>
					</label>
				</div>
				<!--<div class="switchContain">
					<span class="sliderName">Deep Resources</span>
					</br>
					<label id="deepResourceSwitch" class="switch">
						<input id="deepResourceCheckbox" name="deepResourceCheckbox" type="checkbox" onchange="toggleResource()" disabled />
					  <span class="slider round"></span>
					</label>
				</div>-->

				<div class="tileInfoContain">
					<div id="tileData">
						<ul>
							<li><span id="terrainName"></span></li>
							<li><span id="stuffName"></span></li>
							<li><span id="resourceName"></span></li>
						</ul>
					</div>
				</div>
				<div id="versionNum">RimMap v3.1 - @james_simo</div>

			</div>
		</div>
		<!-- UI -->

	</div>
	<script src="scripts/phaser.min.js"></script>
	<script src="scripts/game.js"></script>
	<script>
		let oldTile = null;
		let clickCount = 0;

		let ui = document.getElementById("ui");
		let blackout = document.getElementById("blackout");

		let phaserState = Phaser.GAMES[0].state;
		let loadingMsg = 	document.getElementById("loadingMsg");
		let loadedMapName = "";
		let finishedFrontendLoading = false;

		ui.style.display = "none";
		setInterval(updateTick, 250);

		function updateTick() {

			//document.getElementById("LoadingText").textContent = phaserState.callbackContext.loadingDelta;

			if(finishedFrontendLoading == false && loadedMapName != ""){
				loadingMsg.textContent = "Rendering " + loadedMapName + " " + "("+(phaserState.callbackContext.loadingDelta * 20)+ "%)";
			}
			//loaded
			if (phaserState.current == "DynamicLoad" && ui.style.display == "none") {
				ui.style.display = "block";
			}

			if (phaserState.current == "PreloadAssets") {
				ui.style.display = "none";
				blackout.style.display = "none";
				document.getElementById("settingsBar").style.display = "none";
			}

			if(phaserState.current == "GameState" && blackout.style.display == "block" && phaserState.callbackContext.loadingFinished
			&& finishedFrontendLoading != true){
				blackout.style.display = "none";
				console.log('tick');
				document.getElementById("mainGameBar").style.display = "block";

				finishedFrontendLoading = true;
				document.getElementById("reloadButton").style.display = "block";
			}else if (phaserState.current == "GameState" && phaserState.callbackContext.loadingFinished == false
			&& finishedFrontendLoading != true){
				ui.style.display = "block";
				blackout.style.display = "block";
				document.getElementById("MapSize").textContent = phaserState.callbackContext.worldSize.x + " x " + phaserState.callbackContext.worldSize.y;

			}

			if (phaserState.callbackContext.currentTile) {
				updateTileText();
			}
		}

		let toggleHD = function() {
			document.getElementById("blackout").style.display = "block";
			loadingMsg.textContent = "Loading HD...";

			if (document.getElementById('hdCheckbox').checked) {
				setTimeout(() => {
					blackout.style.display = "none";
					phaserState.callbackContext.showHD();
				}, 1000);
			} else {
				setTimeout(() => {
					blackout.style.display = "none";
					phaserState.callbackContext.hideHD();
				}, 1000);
			}
		}

		let updateTileText = function() {
			var currentTile = phaserState.callbackContext.currentTile;
			if (currentTile != oldTile) {
				oldTile = currentTile
				document.getElementById("terrainName").textContent = currentTile.terrainTile;
				document.getElementById("resourceName").textContent = currentTile.resourceTile;
				document.getElementById("stuffName").textContent = currentTile.stuffTile;
			}
		}

		let toggleMountain = function() {
			blackout.style.display = "block";
			loadingMsg.textContent = "Loading mountains...";

			if (document.getElementById('mountainCheckbox').checked) {
				setTimeout(() => {
					blackout.style.display = "none";
					phaserState.callbackContext.showMountains();
				}, 1000);
			} else {
				setTimeout(() => {
					blackout.style.display = "none";
					phaserState.callbackContext.hideMountains();
				}, 1000);
			}
		}
		let toggleResource = function() {
			blackout.style.display = "block";
			loadingMsg.textContent = "Loading resources...";
			if (document.getElementById('resourceCheckbox').checked) {
				setTimeout(() => {
					blackout.style.display = "none";
					phaserState.callbackContext.showResources();
				}, 1000);
			} else {
				setTimeout(() => {
					blackout.style.display = "none";
					phaserState.callbackContext.hideResources();
				}, 1000);
			}
		}
		let toggleStuff = function() {
			document.getElementById("blackout").style.display = "block";
			loadingMsg.textContent = "Loading stuff...";

			if (document.getElementById('stuffCheckbox').checked) {
				setTimeout(() => {
					blackout.style.display = "none";
					phaserState.callbackContext.showStuff();
				}, 1000);
			} else {
				setTimeout(() => {
					blackout.style.display = "none";
					phaserState.callbackContext.hideStuff();
				}, 1000);
			}
		}

		let uploadSave = function(input) {
			var file = input.files[0];
			if (file) {
				blackout.style.display = "block";

				var reader = new FileReader();
				//SHOW BLACKOUT
				document.getElementById("filemanager").style.display = "none";

				reader.readAsText(file, "UTF-8");
				reader.onload = function(evt) {
					loadedMapName = file.name;
					document.getElementById("MapName").textContent = file.name;

					//REMOVE WHITESPACE
					let data = evt.target.result.replace(/\n[\s]*\n?/gm, "");

					//PARSE THE XML
					let loadedXML = parseXml(data);

					//CONVERT THE XML TO JSON
					let saveGameJson = xmlToJson(loadedXML);

					document.getElementById("settingsBar").style.display = "none";

					//SEND JSON TO PHASER
					phaserState.callbackContext.loadWorld(saveGameJson);

					//HIDE BLACKOUT

				}
				reader.onprogress = function(data) {
            if (data.lengthComputable) {
                var progress = parseInt( ((data.loaded / data.total) * 100), 10 );
								loadingMsg.textContent = "Uploading " + loadedMapName + " ("+Math.round((data.loaded/data.total)*100)+"%)";

            }
        }
				reader.onerror = function(evt) {

				}
			}
		}

		function loadSave(mapName) {

			var req = new XMLHttpRequest();
			req.open("GET", "maps/" + mapName, true);
			blackout.style.display = "block";
			document.getElementById("filemanager").style.display = "none";
			document.getElementById("settingsBar").style.display = "none";

			//PROGRESS.text("Connecting...");
			req.onloadstart = function() {
				loadingMsg.textContent = "Downloading file...";
			}
			req.onreadystatechange = req.onprogress = function() {
				var length = this.getResponseHeader("Content-Length");
				//console.log(length);
				if (length != null) {
					loadingMsg.textContent = "Downloading " + mapName + " ("+Math.round((this.responseText.length/length)*100)+"%)";
					//document.title = "Downloading file ("+Math.round((this.responseText.length/length)*100)+"%)";
					//PROGRESS.progress((this.responseText.length / length) * 100);
				}
			}
			req.onload = function() {
				loadedMapName = mapName;
				document.getElementById("MapName").textContent = mapName;
				//console.log(this.responseText);

				let data = this.responseText.replace(/\n[\s]*\n?/gm, "");

				//PARSE THE XML
				let loadedXML = parseXml(data);

				//CONVERT THE XML TO JSON
				let saveGameJson = xmlToJson(loadedXML);

				//SEND JSON TO PHASER
				phaserState.callbackContext.loadWorld(saveGameJson);



			}
			req.send();
		}
		parseXml = function(xmlStr) {
			return (new window.DOMParser()).parseFromString(xmlStr, "text/xml");
		};

		function xmlToJson(xml) {
			// Create the return object
			var obj = {};

			if (xml.nodeType == 1) { // element
				// do attributes
				if (xml.attributes.length > 0) {
					obj["@attributes"] = {};
					for (var j = 0; j < xml.attributes.length; j++) {
						var attribute = xml.attributes.item(j);
						obj["@attributes"][attribute.nodeName] = attribute.nodeValue;
					}
				}
			} else if (xml.nodeType == 3) { // text
				obj = xml.nodeValue;
			}

			// do children
			// If just one text node inside
			if (xml.hasChildNodes() && xml.childNodes.length === 1 && xml.childNodes[0].nodeType === 3) {
				obj = xml.childNodes[0].nodeValue;
			} else if (xml.hasChildNodes()) {
				for (var i = 0; i < xml.childNodes.length; i++) {
					var item = xml.childNodes.item(i);
					var nodeName = item.nodeName;
					if (typeof(obj[nodeName]) == "undefined") {
						obj[nodeName] = xmlToJson(item);
					} else {
						if (typeof(obj[nodeName].push) == "undefined") {
							var old = obj[nodeName];
							obj[nodeName] = [];
							obj[nodeName].push(old);
						}
						obj[nodeName].push(xmlToJson(item));
					}
				}
			}
			return obj;
		}
	</script>
</body>

</html>

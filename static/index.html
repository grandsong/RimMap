<!DOCTYPE html>
<html lang="en">

<head>
	<meta charset="UTF-8">
	<title>Rimmap - Web based Rimworld map viewer!</title>
	<link rel="stylesheet" href="styles/main.css">
	<link rel="stylesheet" href="styles/ui.css">
</head>

<body>
	<div id="blackout">
		<div class="sk-folding-cube">
			<div class="sk-cube1 sk-cube"></div>
			<div class="sk-cube2 sk-cube"></div>
			<div class="sk-cube4 sk-cube"></div>
			<div class="sk-cube3 sk-cube"></div>
		</div>
		<h1>Loading...</h1>
		<i>this may take a while...</i>
	</div>
	<div id="content">

		<div id="window"></div>
		<span id="LoadingText">0</span>
		<div id="ui">

			<div id="topbar">
				<span id="FileName"></span> <span id="MapSize"></span>

				<!--<div class="maps">
					<select id="levels">
						<option>Option2</option>
						<option>Option1</option>

					 </select>
				</div>-->
				<button id="reloadButton" onclick="location.reload()"> upload new</button>
			</div>

			<div id="filemanager">
			<div id="filegroup">
				<input type="file" id="file_input" accept=".rws" onchange="uploadSave(this);" />
				<label for="file">
					<svg version="1.1" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink">
					    <!--Generated by IJSVG (https://github.com/curthard89/IJSVG)-->
					    <g fill="none">
					        <path d="M0,0h24v24h-24Z" transform="translate(0, 0.006)"></path>
					    </g>
					    <g id="dlSvg" fill="#ffffff">
					        <path d="M0,4.707l1.414,1.414l2.293,-2.293v12.586h2v-12.586l2.293,2.293l1.414,-1.414l-4.707,-4.707Z" transform="translate(7.293, 5.588)"></path>
					        <path d="M14,0h-12c-1.104,0 -2,0.896 -2,2v10c0,1.102 0.896,2 2,2h1v-2h-1v-10h12v10h-1v2h1c1.104,0 2,-0.898 2,-2v-10c0,-1.104 -0.896,-2 -2,-2Z" transform="translate(4, 2.002)"></path>
					    </g>
					</svg>
				</label>
				<h3>Upload Rimworld save file</h3>
			</div>
			<div id="savesgroup">
				<div id="save1" class="singleSave" onclick="loadSave('Nova.rws')">
					Nova
				</div>
				<div id="save2" class="singleSave" onclick="loadSave('Temperate.rws')">
					Temperate
				</div>
				<div id="save3" class="singleSave" onclick="loadSave('Arrivals.rws')">
					Arrivals
				</div>
				<div id="save4" class="singleSave" onclick="loadSave('Arrivals.rws')">
					Arrivals
				</div>
				<div id="save3" class="singleSave" onclick="loadSave('Arrivals.rws')">
					Arrivals
				</div>
			</div>
		</div>


			<div id="bottomBar">
				<div class="switchContain">
					<span class="sliderName">Items</span>
					</br>
					<label id="stuffSwitch" class="switch">
						<input id="stuffCheckbox" name="stuffCheckbox" type="checkbox" onchange="toggleStuff()" checked />
					  <span class="slider round"></span>
					</label>
				</div>
				<!--<div class="switchContain">
					<span class="sliderName">Roof</span>
					</br>
					<label id="roofSwitch" class="switch">
						<input id="roofCheckbox" name="roofCheckbox" type="checkbox" onchange="toggleRoof()" />
					  <span class="slider round"></span>
					</label>
				</div>-->
				<div class="switchContain">
					<span class="sliderName">Mountains</span>
					</br>
					<label id="mountainsSwitch" class="switch">
						<input id="mountainCheckbox" name="mountainCheckbox" type="checkbox" onchange="toggleMountain()" checked />
					  <span class="slider round"></span>
					</label>
				</div>
				<div class="switchContain">
					<span class="sliderName">Resources</span>
					</br>
					<label id="resourceSwitch" class="switch">
						<input id="resourceCheckbox" name="resourceCheckbox" type="checkbox" onchange="toggleResource()"  />
					  <span class="slider round"></span>
					</label>
				</div>
				<div class="switchContain">
					<span class="sliderName">Deep Resources</span>
					</br>
					<label id="deepResourceSwitch" class="switch">
						<input id="deepResourceCheckbox" name="deepResourceCheckbox" type="checkbox" onchange="toggleResource()" disabled />
					  <span class="slider round"></span>
					</label>
				</div>

				<div class="tileInfoContain">
					<div id="tileData">
						<ul>
							<li><span id="terrainName"></span></li>
							<li><span id="stuffName"></span></li>
							<li><span id="resourceName"></span></li>
						</ul>
					</div>
				</div>
			</div>
		</div>
		<!-- UI -->

	</div>
	<script src="scripts/phaser.min.js"></script>
	<script src="scripts/game.js"></script>
	<script>
		let oldTile = null;
		let clickCount = 0;
		document.getElementById("ui").style.display = "none";
		setInterval(updateTick, 250);

		function updateTick() {

			document.getElementById("LoadingText").textContent = Phaser.GAMES[0].state.callbackContext.loadingDelta;

			if (Phaser.GAMES[0].state.current == "GameState" && document.getElementById("ui").style.display == "none") {
				document.getElementById("ui").style.display = "block";
			}
			if (Phaser.GAMES[0].state.callbackContext.currentTile) {
				updateTileText();
			}
		}

		let updateTileText = function() {
			var currentTile = Phaser.GAMES[0].state.callbackContext.currentTile;
			if (currentTile != oldTile) {
				oldTile = currentTile
				document.getElementById("terrainName").textContent = currentTile.terrainTile;
				document.getElementById("resourceName").textContent = currentTile.resourceTile;


				document.getElementById("stuffName").textContent = currentTile.stuffTile;

			}
		}


		let toggleMountain = function() {
			document.getElementById("blackout").style.display = "block";
			if (document.getElementById('mountainCheckbox').checked) {
				setTimeout(() => {
					document.getElementById("blackout").style.display = "none";
					Phaser.GAMES[0].state.callbackContext.showMountains();
				}, 1000);
			} else {
				setTimeout(() => {
					document.getElementById("blackout").style.display = "none";
					Phaser.GAMES[0].state.callbackContext.hideMountains();
				}, 1000);
			}
		}
		let toggleResource = function() {
			document.getElementById("blackout").style.display = "block";
			if (document.getElementById('resourceCheckbox').checked) {
				setTimeout(() => {
					document.getElementById("blackout").style.display = "none";
					Phaser.GAMES[0].state.callbackContext.showResources();
				}, 1000);
			} else {
				setTimeout(() => {
					document.getElementById("blackout").style.display = "none";
					Phaser.GAMES[0].state.callbackContext.hideResources();
				}, 1000);
			}
		}
		let toggleStuff = function() {
			document.getElementById("blackout").style.display = "block";
			if (document.getElementById('stuffCheckbox').checked) {
				setTimeout(() => {
					document.getElementById("blackout").style.display = "none";
					Phaser.GAMES[0].state.callbackContext.showStuff();
				}, 1000);
			} else {
				setTimeout(() => {
					document.getElementById("blackout").style.display = "none";
					Phaser.GAMES[0].state.callbackContext.hideStuff();
				}, 1000);
			}
		}

		let uploadSave = function(input) {
			var file = input.files[0];
			if (file) {
				var reader = new FileReader();
				//SHOW BLACKOUT
				document.getElementById("blackout").style.display = "block";
				document.getElementById("filemanager").style.display = "none";

				reader.readAsText(file, "UTF-8");
				reader.onload = function(evt) {

					document.getElementById("FileName").textContent = file.name;
					//REMOVE WHITESPACE
					let data = evt.target.result.replace(/\n[\s]*\n?/gm, "");

					//PARSE THE XML
					let loadedXML = parseXml(data);

					//CONVERT THE XML TO JSON
					let saveGameJson = xmlToJson(loadedXML);

					//SEND JSON TO PHASER
					Phaser.GAMES[0].state.callbackContext.loadWorld(saveGameJson);

					//HIDE BLACKOUT
					document.getElementById("blackout").style.display = "none";
					document.getElementById("bottomBar").style.display = "block";
				}
				reader.onerror = function(evt) {

				}
			}
		}

		function loadSave(mapName) {

			var req = new XMLHttpRequest();
			req.open("GET", "maps/" + mapName, true);
			document.getElementById("blackout").style.display = "block";
			document.getElementById("filemanager").style.display = "none";

			//PROGRESS.text("Connecting...");
			req.onloadstart = function() {
				console.log("Downloading file...");

			}
			req.onreadystatechange = req.onprogress = function() {
				var length = this.getResponseHeader("Content-Length");
				//console.log(length);
				if (length != null) {
					//document.title = "Downloading file ("+Math.round((this.responseText.length/length)*100)+"%)";
					//PROGRESS.progress((this.responseText.length / length) * 100);
				}
			}
			req.onload = function() {
				document.getElementById("blackout").style.display = "none";
				document.getElementById("bottomBar").style.display = "block";
				console.log(this.responseText);

				let data = this.responseText.replace(/\n[\s]*\n?/gm, "");

				//PARSE THE XML
				let loadedXML = parseXml(data);

				//CONVERT THE XML TO JSON
				let saveGameJson = xmlToJson(loadedXML);

				//SEND JSON TO PHASER
				Phaser.GAMES[0].state.callbackContext.loadWorld(saveGameJson);

			}
			req.send();
		}
		parseXml = function(xmlStr) {
			return (new window.DOMParser()).parseFromString(xmlStr, "text/xml");
		};

		function xmlToJson(xml) {
			// Create the return object
			var obj = {};

			if (xml.nodeType == 1) { // element
				// do attributes
				if (xml.attributes.length > 0) {
					obj["@attributes"] = {};
					for (var j = 0; j < xml.attributes.length; j++) {
						var attribute = xml.attributes.item(j);
						obj["@attributes"][attribute.nodeName] = attribute.nodeValue;
					}
				}
			} else if (xml.nodeType == 3) { // text
				obj = xml.nodeValue;
			}

			// do children
			// If just one text node inside
			if (xml.hasChildNodes() && xml.childNodes.length === 1 && xml.childNodes[0].nodeType === 3) {
				obj = xml.childNodes[0].nodeValue;
			} else if (xml.hasChildNodes()) {
				for (var i = 0; i < xml.childNodes.length; i++) {
					var item = xml.childNodes.item(i);
					var nodeName = item.nodeName;
					if (typeof(obj[nodeName]) == "undefined") {
						obj[nodeName] = xmlToJson(item);
					} else {
						if (typeof(obj[nodeName].push) == "undefined") {
							var old = obj[nodeName];
							obj[nodeName] = [];
							obj[nodeName].push(old);
						}
						obj[nodeName].push(xmlToJson(item));
					}
				}
			}
			return obj;
		}
	</script>
</body>

</html>

<!DOCTYPE html>
<html lang="en">

<head>
	<meta charset="UTF-8">
	<title>Rimmap - Web based Rimworld map viewer!</title>
	<link rel="stylesheet" href="styles/main.css">
</head>

<body>
	<div id="blackout">
		<h1>Loading...</h1>
	</div>
	<div id="content">

		<div id="window"></div>
		<div id="ui">

			<div id="filegroup">
				<input type="file" id="file_input" accept=".rws" onchange="uploadSave(this);" />
				<label for="file">
								<svg version="1.1" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink">
								    <!--Generated by IJSVG (https://github.com/curthard89/IJSVG)-->
								    <g fill="none">
								        <path d="M0,0h24v24h-24Z" transform="translate(0, 0.006)"></path>
								    </g>
								    <g id="dlSvg" fill="#F0D104">
								        <path d="M0,4.707l1.414,1.414l2.293,-2.293v12.586h2v-12.586l2.293,2.293l1.414,-1.414l-4.707,-4.707Z" transform="translate(7.293, 5.588)"></path>
								        <path d="M14,0h-12c-1.104,0 -2,0.896 -2,2v10c0,1.102 0.896,2 2,2h1v-2h-1v-10h12v10h-1v2h1c1.104,0 2,-0.898 2,-2v-10c0,-1.104 -0.896,-2 -2,-2Z" transform="translate(4, 2.002)"></path>
								    </g>
								</svg></label>




			</div>
			<label  id="stuffSwitch"class="switch">
				<input id="stuffCheckbox" name="stuffCheckbox" type="checkbox" onchange="toggleStuff()" checked />
			  <span class="slider round"></span>
				<label>Show items</label>
			</label>

			<label  id="roofSwitch"class="switch">
				<input id="roofCheckbox" name="roofCheckbox" type="checkbox" onchange="toggleRoof()" />
			  <span class="slider round"></span>
				<label>Show room</label>
			</label>

			<label id="resourceSwitch"  class="switch">
				<input id="resourceCheckbox" name="resourceCheckbox" type="checkbox" onchange="toggleResource()" />
			  <span class="slider round"></span>
				<label>Show resources</label>
			</label>
			<a href="function(){window.refresh()}"> upload new</a>

		</div>

	</div>
	<script src="scripts/phaser.min.js"></script>
	<script src="scripts/game.js"></script>
	<script>


	document.getElementById("ui").style.display = "none";
	setInterval(updateTick, 1000);
	function updateTick() {
/*	    var d = new Date();
	    console.log(d.toLocaleTimeString());*/



			if(Phaser.GAMES[0].state.current == "GameState" &&  document.getElementById("ui").style.display == "none"){
				document.getElementById("ui").style.display = "block";
			}
	}



		let toggleStuff = function() {
			document.getElementById("blackout").style.display = "block";
			if (document.getElementById('stuffCheckbox').checked) {
				setTimeout(() => {
					document.getElementById("blackout").style.display = "none";
					Phaser.GAMES[0].state.callbackContext.renderStuff();
				}, 1000);
			} else {
				setTimeout(() => {
					document.getElementById("blackout").style.display = "none";
					Phaser.GAMES[0].state.callbackContext.destoryStuff();
				}, 1000);
			}
		}

		let uploadSave = function(input) {
			var file = input.files[0];
			if (file) {
				var reader = new FileReader();
				//SHOW BLACKOUT
				document.getElementById("blackout").style.display = "block";
				document.getElementById("filegroup").style.display = "none";

				reader.readAsText(file, "UTF-8");
				reader.onload = function(evt) {

					//REMOVE WHITESPACE
					let data = evt.target.result.replace(/\n[\s]*\n?/gm, "");

					//PARSE THE XML
					let loadedXML = parseXml(data);

					//CONVERT THE XML TO JSON
					let saveGameJson = xmlToJson(loadedXML);

					//SEND JSON TO PHASER
					Phaser.GAMES[0].state.callbackContext.loadWorld(saveGameJson);

					//HIDE BLACKOUT
					document.getElementById("blackout").style.display = "none";
				}
				reader.onerror = function(evt) {

				}
			}
		}
		parseXml = function(xmlStr) {
			return (new window.DOMParser()).parseFromString(xmlStr, "text/xml");
		};

		function xmlToJson(xml) {
			// Create the return object
			var obj = {};

			if (xml.nodeType == 1) { // element
				// do attributes
				if (xml.attributes.length > 0) {
					obj["@attributes"] = {};
					for (var j = 0; j < xml.attributes.length; j++) {
						var attribute = xml.attributes.item(j);
						obj["@attributes"][attribute.nodeName] = attribute.nodeValue;
					}
				}
			} else if (xml.nodeType == 3) { // text
				obj = xml.nodeValue;
			}

			// do children
			// If just one text node inside
			if (xml.hasChildNodes() && xml.childNodes.length === 1 && xml.childNodes[0].nodeType === 3) {
				obj = xml.childNodes[0].nodeValue;
			} else if (xml.hasChildNodes()) {
				for (var i = 0; i < xml.childNodes.length; i++) {
					var item = xml.childNodes.item(i);
					var nodeName = item.nodeName;
					if (typeof(obj[nodeName]) == "undefined") {
						obj[nodeName] = xmlToJson(item);
					} else {
						if (typeof(obj[nodeName].push) == "undefined") {
							var old = obj[nodeName];
							obj[nodeName] = [];
							obj[nodeName].push(old);
						}
						obj[nodeName].push(xmlToJson(item));
					}
				}
			}
			return obj;
		}
	</script>
</body>

</html>

<!DOCTYPE html>
<html lang="en">
<head>
	<meta charset="UTF-8">
	<title>Phaser with a sprinkle of ES6 Dust!</title>
	<link rel="stylesheet" href="styles/main.css">
</head>
<body>
	<div id="blackout"></div>
	<div id="content">
		Upload your Rimworld save! (b18)<br/>

		<input type="file" id="file_input" accept=".rws" onchange="uploadSave(this);" /><br/>
		<div id="window"></div>

	</div>
	<script src="scripts/phaser.min.js"></script>
	<script src="scripts/game.js"></script>
	<script>

		let uploadSave = function(input){
			var file = input.files[0];
			if (file) {
				var reader = new FileReader();
				//SHOW BLACKOUT
				document.getElementById("blackout").style.display = "block";
				reader.readAsText(file, "UTF-8");
				reader.onload = function(evt) {

					//REMOVE WHITESPACE
					let data = evt.target.result.replace(/\n[\s]*\n?/gm, "");

					//PARSE THE XML
					let loadedXML = parseXml(data);

					//CONVERT THE XML TO JSON
					let saveGameJson = xmlToJson(loadedXML);

					//SEND JSON TO PHASER
					Phaser.GAMES[0].state.callbackContext.loadWorld(saveGameJson);

					//HIDE BLACKOUT
					document.getElementById("blackout").style.display = "none";
				}
				reader.onerror = function(evt) {

				}
			}
		}
		parseXml = function(xmlStr) {
			return (new window.DOMParser()).parseFromString(xmlStr, "text/xml");
		};

		function xmlToJson(xml) {
      // Create the return object
      var obj = {};

      if (xml.nodeType == 1) { // element
        // do attributes
        if (xml.attributes.length > 0) {
          obj["@attributes"] = {};
          for (var j = 0; j < xml.attributes.length; j++) {
            var attribute = xml.attributes.item(j);
            obj["@attributes"][attribute.nodeName] = attribute.nodeValue;
          }
        }
      } else if (xml.nodeType == 3) { // text
        obj = xml.nodeValue;
      }

      // do children
      // If just one text node inside
      if (xml.hasChildNodes() && xml.childNodes.length === 1 && xml.childNodes[0].nodeType === 3) {
        obj = xml.childNodes[0].nodeValue;
      } else if (xml.hasChildNodes()) {
        for (var i = 0; i < xml.childNodes.length; i++) {
          var item = xml.childNodes.item(i);
          var nodeName = item.nodeName;
          if (typeof(obj[nodeName]) == "undefined") {
            obj[nodeName] = xmlToJson(item);
          } else {
            if (typeof(obj[nodeName].push) == "undefined") {
              var old = obj[nodeName];
              obj[nodeName] = [];
              obj[nodeName].push(old);
            }
            obj[nodeName].push(xmlToJson(item));
          }
        }
      }
      return obj;
    }

	</script>
</body>
</html>
